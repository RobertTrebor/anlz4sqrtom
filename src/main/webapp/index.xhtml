<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE composition PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<ui:composition xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
	  xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
	  template="/resources/templates/templateMain.xhtml">

	<ui:define name="main">
		<f:event listener="#{basicBean.onStart()}" type="preRenderView"/>
			<div class="container-fluid">
				<h:form>
					<p:panelGrid columns="3" columnClasses="ui-g-12 ui-xl-4, ui-g-12 ui-xl-4, ui-g-12 ui-xl-4" layout="grid" rendered="#{basicBean.isAuthenticated()}">
						<p:panelGrid>
							<p:inputNumber value="#{form.numCheckins}" />
							<p:commandButton action="#{basicBean.loadCheckins()}" value="Checkins" update="venuetable" />
							<p:commandButton action="#{basicBean.loadCheckinsWithComments()}" value="Checkins Comments" update="venuetable" />
						</p:panelGrid>
						<p:panelGrid>
							<p:commandButton action="#{basicBean.load()}" value="Load Venues" update="venuetable" />
							<p:commandButton action="#{basicBean.loadHistory()}" value="History" update="venuetable" />
						</p:panelGrid>
						<p:panelGrid>
							<p:commandButton action="#{basicBean.save()}" value="Save DB" update="venuetable" disabled="true" />
							<p:commandButton action="#{basicBean.loadFromDb()}" value="Load DB" update="venuetable" disabled="true" />
						</p:panelGrid>
					</p:panelGrid>
				</h:form>

				<p:panelGrid id="venuetable" columnClasses="ui-g-12" columns="1" styleClass="ui-fluid">
                    <f:facet name="header">Venue List</f:facet>
						<h:form id="venuetableform">
							<p:dataTable var="venue" value="#{form.venues}" rendered="#{form.view == 0}"
										 rowKey="#{venue.name}" paginator="true" rows="15"
										 selection="#{form.selectedVenue}" selectionMode="single">

								<p:ajax event="rowSelect" update="display"
										oncomplete="PF('venueDialog').show();" />

								<p:column headerText="Name" sortBy="name" filterBy="name" id="titlename">
									#{venue.name}
								</p:column>

								<p:column headerText="Address" sortBy="address" sortable="true" filterBy="address" id="titleaddress">
									#{venue.location.address}
								</p:column>

								<p:column headerText="City" sortBy="city" filterBy="city" id="titlecity">
									#{venue.location.city}
								</p:column>
							</p:dataTable>

							<p:dataTable var="history" value="#{form.venueHistories}" rendered="#{form.view == 1}"
										 rowKey="#{venue.name}" paginator="true" rows="15">

								<p:column headerText="Checkins" sortBy="Checkins" filterBy="name" >
									#{history.beenHere}
								</p:column>

								<p:column headerText="Name" sortBy="name" filterBy="name" >
									#{history.venue.name}
								</p:column>

								<p:column headerText="Address" sortBy="address" filterBy="address">
									#{history.venue.location.address}
								</p:column>

								<p:column headerText="City" sortBy="city" filterBy="city" >
									#{history.venue.location.city}
								</p:column>
							</p:dataTable>

							<p:dataTable var="historydb" value="#{form.venueHistoriesDb}" rendered="#{form.view == 2}"
										 selectionMode="single" selection="#{form.selectedHistory}"
										 rowKey="#{historydb.id}" paginator="true" rows="15">

								<p:column id="idCol" headerText="Id" sortable="true" sortBy="#{historydb.id}"
										  filterBy="#{historydb.id}"  >
									#{historydb.id}
								</p:column>

								<p:column headerText="Checkins" sortable="true" sortBy="#{historydb.beenHere}" filterBy="#{historydb.beenHere}" >
									#{historydb.beenHere}
								</p:column>

								<p:column headerText="Name" sortBy="#{historydb.venue.name}" filterBy="#{historydb.venue.name}" >
									#{historydb.venue.name}
								</p:column>

								<p:column headerText="Address" sortBy="#{historydb.venue.location.address}" filterBy="#{historydb.venue.location.address}">
									#{historydb.venue.location.address}
								</p:column>

								<p:column headerText="City" sortBy="#{historydb.venue.location.city}" filterBy="#{historydb.venue.location.city}" >
									#{historydb.venue.location.city}
								</p:column>
							</p:dataTable>

							<p:dataTable var="checkins" value="#{form.checkins}" rendered="#{form.view == 3}"
										 selectionMode="single" selection="#{form.selectedCheckin}"
										 rowKey="#{checkins.id}" paginator="true" rows="15">

								<p:ajax event="rowSelect" update="checkingDlg" listener="#{basicBean.retrieveComment()}"
										oncomplete="PF('checkinDialog').show();" />

								<p:column headerText="Id" sortable="true" sortBy="#{checkins.id}"
										  filterBy="#{checkins.id}"  >
									#{checkins.id}
								</p:column>

								<p:column headerText="Checkins" sortable="true" sortBy="#{checkins.createdAt}" filterBy="#{checkins.createdAt}" >
									<h:outputText value="#{checkins.createdAt * 1000}">
										<f:convertDateTime pattern="dd/MM/yyyy"/>
									</h:outputText>
								</p:column>

								<p:column headerText="Name" sortBy="#{checkins.venue.name}" filterBy="#{checkins.venue.name}" >
									#{checkins.venue.name}
								</p:column>

								<p:column headerText="Address" sortBy="#{checkins.venue.location.address}" filterBy="#{checkins.venue.location.address}">
									#{checkins.venue.location.address}
								</p:column>

								<p:column headerText="City" sortBy="#{checkins.venue.location.city}" filterBy="#{checkins.venue.location.city}" >
									#{checkins.venue.location.city}
								</p:column>
							</p:dataTable>
                        </h:form>
			    </p:panelGrid>
                <p:dialog header="Venue Details" widgetVar="venueDialog" closable="false"
                          resizable="false" width="400" showEffect="explode" onHide="PF('venueDialog').hide();"
                          hideEffect="explode" appendTo="@(body)">
                    <f:facet name="footer">
                        <p:commandButton value="close" oncomplete="PF('venueDialog').hide();"/>
                    </f:facet>
                    <h:panelGrid id="display" columns="2" cellpadding="4" styleClass="ui-fluid">
                        <h:outputText value="Name:" />
                        <h:outputText value="#{form.selectedVenue.name}" id="name" />

                        <h:outputText value="Address:" />
                        <h:outputText value="#{form.selectedVenue.location.address}" id="address" />

                        <h:outputText value="Zip:" />
                        <h:outputText value="#{form.selectedVenue.location.postalCode}" id="postalCode" />

                        <h:outputText value="City:" />
                        <h:outputText value="#{form.selectedVenue.location.city}" id="city" />

                        <h:outputText value="Id:" />
                        <h:outputText value="#{form.selectedVenue.id}"/>

                    </h:panelGrid>
                </p:dialog>
                <p:dialog id="checkingDlg" header="Checkin Details" widgetVar="checkinDialog" appendTo="@(body)"
                          resizable="false" width="400" showEffect="explode"
                          hideEffect="explode" onHide="PF('checkinDialog').hide();">
					<f:facet name="footer">
						<p:commandButton value="close" oncomplete="PF('venueDialog').hide();"/>
					</f:facet>
                    <h:panelGrid id="checkinDlgPanel" columns="2" cellpadding="4">

                        <h:outputText value="ID:" />
                        <h:outputText value="#{form.selectedCheckin.id}" />

                        <h:outputText value="Address:" />
                        <h:outputText value="#{form.selectedCheckin.venue.location.address}"/>

                        <h:outputText value="Zip:" />
                        <h:outputText value="#{form.selectedCheckin.venue.location.postalCode}"/>

                        <h:outputText value="City:" />
                        <h:outputText value="#{form.selectedCheckin.venue.location.city}" />

                        <h:outputText value="Comment:" />
                        <h:outputText value="#{form.selectedComment}" />

                    </h:panelGrid>
                </p:dialog>
                <p:panelGrid columnClasses="ui-g-12 ui-xl-6, ui-g-12 ui-xl-6" columns="2" layout="grid" styleClass="ui-fluid">
					<h:form>
						<p:fieldset legend="Map" toggleable="true">
							<p:growl id="messages" showDetail="true" life="2000" />
							<p:gmap center="#{mapBean.coordinates}" zoom="15" type="HYBRID"
									style="width:480px;height:300px" model="#{mapBean.model}">
								<p:ajax event="stateChange" listener="#{mapBean.onStateChange}" update="messages" />
								<p:ajax event="pointSelect" listener="#{mapBean.onPointSelect}" oncomplete="updateRC();" update="messages coordinatesform venuetable" />
							</p:gmap>
						</p:fieldset>
					</h:form>

					<p:fieldset legend="Categories" toggleable="true" collapsed="false" styleClass="ui-fluid">
						<h:form>
							<p:tree id="tree" value="#{categoriesController.root}" var="node"
									selectionMode="single" selection="#{categoriesController.selectedNode}">
								<p:ajax event="select" listener="#{categoriesController.onNodeSelect}" oncomplete="updateRC();" />
								<p:treeNode id="treeNode">
									<h:outputText value="#{node}" id="lblNode" />
								</p:treeNode>
							</p:tree>
						</h:form>
					</p:fieldset>
				</p:panelGrid>
			</div>
			<p:ajaxStatus
				style="width:64px;height:64px;position:fixed;top:5px;left:5px">
				<f:facet name="start">
					<p:graphicImage library="img" name="ajax-loader.gif" />
				</f:facet>

				<f:facet name="complete">
					<h:outputText value="" />
				</f:facet>
			</p:ajaxStatus>

			<p:remoteCommand name="updateRC" actionListener="#{basicBean.update()}" update="venuetable"/>

	</ui:define>
</ui:composition>